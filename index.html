<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repo Tree Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Devicon stylesheet for file-specific icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css">
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #1f2937;
            --card-bg: #f9fafb;
            --border-color: #e5e7eb;
            --icon-color: #4b5563; /* Darkened for better contrast */
            --hover-bg: #f3f4f6;
            --link-color: #3b82f6;
            --input-bg: #ffffff;
            --button-bg: #4f46e5;
            --button-text: #ffffff;
        }

        html.dark {
            --bg-color: #111827;
            --text-color: #f9fafb;
            --card-bg: #1f2937;
            --border-color: #374151;
            --icon-color: #9ca3af;
            --hover-bg: #374151;
            --link-color: #60a5fa;
            --input-bg: #374151;
            --button-bg: #6366f1;
            --button-text: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Custom scrollbar for a cleaner look */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--icon-color); }

        /* Ensure consistent icon sizing */
        .icon-container {
            width: 1.25rem; height: 1.25rem; display: flex;
            align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="p-4 md:p-6 w-full h-screen flex flex-col">
        
        <!-- Welcome / Initial State -->
        <div id="welcome-view" class="hidden items-center justify-center flex-grow">
            <div class="text-center p-4 sm:p-8 rounded-lg" style="background-color: var(--card-bg);">
                <svg class="mx-auto h-12 w-12" style="color: var(--icon-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
                </svg>
                <h2 class="mt-4 text-xl font-semibold">GitHub Repository Viewer</h2>
                <p class="mt-2 text-sm" style="color: var(--icon-color);">
                    To get started, add a GitHub repository URL to the iframe's `src` attribute.
                </p>
                <p class="mt-4 text-xs bg-gray-100 dark:bg-gray-800 p-2 rounded-md font-mono">
                    Example: `.../index.html?repo=https://github.com/facebook/react`
                </p>
                 <p class="mt-2 text-xs" style="color: var(--icon-color);">
                    You can also specify a theme: `&theme=light` or `&theme=dark`<br>
                    Expand folders by default: `&expand=true`<br>
                    Make the background transparent: `&transparent=true`
                </p>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loading-view" class="hidden items-center justify-center flex-grow">
            <div class="flex flex-col items-center">
                <svg class="animate-spin h-8 w-8" style="color: var(--icon-color);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-sm font-medium">Fetching repository data...</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-view" class="hidden items-center justify-center flex-grow">
             <div class="text-center p-4 sm:p-8 rounded-lg" style="background-color: var(--card-bg);">
                <svg class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="mt-4 text-xl font-semibold">Something went wrong</h2>
                <p id="error-message" class="mt-2 text-sm" style="color: var(--icon-color);"></p>
            </div>
        </div>

        <!-- Rate Limit View -->
        <div id="rate-limit-view" class="hidden items-center justify-center flex-grow">
             <div class="text-center p-4 sm:p-8 rounded-lg max-w-lg w-full" style="background-color: var(--card-bg);">
                <svg class="mx-auto h-12 w-12 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h2 class="mt-4 text-xl font-semibold">API Rate Limit Exceeded</h2>
                <p class="mt-2 text-sm" style="color: var(--icon-color);">You've made too many requests. To continue, please provide a GitHub Personal Access Token.</p>
                
                <div class="mt-4 text-left">
                    <label for="pat-input" class="block text-sm font-medium mb-1">Personal Access Token (PAT)</label>
                    <input type="password" id="pat-input" class="w-full px-3 py-2 rounded-md border text-sm" style="background-color: var(--input-bg); border-color: var(--border-color);" placeholder="ghp_...">
                </div>

                <div class="mt-4 flex flex-col sm:flex-row gap-2">
                    <button id="save-token-btn" class="w-full px-4 py-2 rounded-md font-semibold text-sm" style="background-color: var(--button-bg); color: var(--button-text);">Save and Retry</button>
                    <button id="clear-token-btn" class="w-full px-4 py-2 rounded-md font-semibold text-sm" style="background-color: var(--hover-bg); color: var(--text-color);">Clear Saved Token</button>
                </div>

                <p class="mt-4 text-xs text-left" style="color: var(--icon-color);">
                    <a href="https://github.com/settings/tokens/new?scopes=public_repo&description=Repo%20Tree%20Viewer" target="_blank" class="underline" style="color: var(--link-color);">Create a new token</a> with only `public_repo` scope. This token will be stored securely in your browser's local storage.
                </p>
            </div>
        </div>

        <!-- Tree View -->
        <div id="tree-view" class="hidden flex-col h-full w-full" style="background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.75rem;">
            <div class="p-4 border-b" style="border-color: var(--border-color);">
                <h1 id="repo-title" class="text-lg font-bold"></h1>
                <a id="repo-link" href="#" target="_blank" rel="noopener noreferrer" class="text-sm hover:underline" style="color: var(--link-color);">View on GitHub</a>
            </div>
            <div id="tree-container" class="p-4 overflow-y-auto flex-grow custom-scrollbar">
                <!-- Tree will be rendered here -->
            </div>
        </div>
    </div>

    <script type="module">
        const GITHUB_TOKEN_KEY = 'github_pat';

        const ICONS = {
            folder: `
                <svg class="w-5 h-5" style="color: var(--icon-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                </svg>`,
            folderOpen: `
                <svg class="w-5 h-5" style="color: var(--icon-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                </svg>`,
            file: `
                <svg class="w-5 h-5" style="color: var(--icon-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>`
        };

        const FILE_ICON_MAP = {
            'js': 'devicon-javascript-plain', 'jsx': 'devicon-react-original',
            'ts': 'devicon-typescript-plain', 'tsx': 'devicon-react-original',
            'html': 'devicon-html5-plain', 'css': 'devicon-css3-plain',
            'scss': 'devicon-sass-original', 'json': 'devicon-json-plain',
            'md': 'devicon-markdown-original', 'py': 'devicon-python-plain',
            'java': 'devicon-java-plain', 'c': 'devicon-c-plain',
            'cpp': 'devicon-cplusplus-plain', 'cs': 'devicon-csharp-plain',
            'go': 'devicon-go-original-wordmark', 'php': 'devicon-php-plain',
            'rb': 'devicon-ruby-plain', 'swift': 'devicon-swift-plain',
            'dockerfile': 'devicon-docker-plain', 'yml': 'devicon-yaml-plain',
            'yaml': 'devicon-yaml-plain', 'sql': 'devicon-azuresqldatabase-plain',
            'gitignore': 'devicon-git-plain', 'npmrc': 'devicon-npm-original-wordmark',
            'lock': 'devicon-npm-original-wordmark', 'png': 'devicon-photoshop-plain',
            'jpg': 'devicon-photoshop-plain', 'jpeg': 'devicon-photoshop-plain',
            'gif': 'devicon-photoshop-plain', 'svg': 'devicon-svg-plain',
            'ico': 'devicon-photoshop-plain', 'txt': 'devicon-file-plain',
        };


        // --- DOM Elements ---
        const views = {
            welcome: document.getElementById('welcome-view'),
            loading: document.getElementById('loading-view'),
            error: document.getElementById('error-view'),
            tree: document.getElementById('tree-view'),
            rateLimit: document.getElementById('rate-limit-view')
        };
        const patInput = document.getElementById('pat-input');
        const saveTokenBtn = document.getElementById('save-token-btn');
        const clearTokenBtn = document.getElementById('clear-token-btn');
        const repoTitleEl = document.getElementById('repo-title');
        const repoLinkEl = document.getElementById('repo-link');
        const treeContainer = document.getElementById('tree-container');
        const errorMessageEl = document.getElementById('error-message');
        const appContainer = document.getElementById('app-container');

        
        function getIconForFile(filename) {
            const lowerFilename = filename.toLowerCase();
            const extension = lowerFilename.split('.').pop();
            if (FILE_ICON_MAP[lowerFilename]) {
                return FILE_ICON_MAP[lowerFilename];
            }
            return FILE_ICON_MAP[extension] || null;
        }

        const showView = (viewName) => {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            Object.values(views).forEach(view => view.classList.remove('flex'));
            if (views[viewName]) {
                 views[viewName].classList.remove('hidden');
                 views[viewName].classList.add('flex');
            }
        };

        const parseGitHubUrl = (url) => {
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname !== 'github.com') return null;
                const parts = urlObj.pathname.split('/').filter(Boolean);
                if (parts.length >= 2) {
                    return { owner: parts[0], repo: parts[1].replace('.git', '') };
                }
                return null;
            } catch (e) { return null; }
        };

        function buildFileTree(fileList) {
            const root = {};
            for (const item of fileList) {
                const parts = item.path.split('/');
                let currentLevel = root;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (!currentLevel[part]) {
                        const isLast = i === parts.length - 1;
                        const type = isLast ? item.type : 'tree';
                        currentLevel[part] = {
                            name: part, type: type,
                            children: type === 'tree' ? {} : null
                        };
                    }
                    if (currentLevel[part] && currentLevel[part].children) {
                       currentLevel = currentLevel[part].children;
                    }
                }
            }
            return root;
        }

        function renderTree(treeNode, container, expandFolders) {
            const sortedKeys = Object.keys(treeNode).sort((a, b) => {
                const nodeA = treeNode[a];
                const nodeB = treeNode[b];
                if (nodeA.type === 'tree' && nodeB.type !== 'tree') return -1;
                if (nodeA.type !== 'tree' && nodeB.type === 'tree') return 1;
                return a.localeCompare(b);
            });

            const ul = document.createElement('ul');
            ul.className = 'space-y-1';

            for (const key of sortedKeys) {
                const node = treeNode[key];
                const li = document.createElement('li');
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center space-x-2 p-1 rounded-md cursor-pointer';
                itemDiv.style.transition = 'background-color 0.2s';
                
                itemDiv.onmouseover = () => itemDiv.style.backgroundColor = 'var(--hover-bg)';
                itemDiv.onmouseout = () => itemDiv.style.backgroundColor = 'transparent';

                const iconContainer = document.createElement('div');
                iconContainer.className = 'icon-container';

                if (node.type === 'tree') {
                    iconContainer.innerHTML = expandFolders ? ICONS.folderOpen : ICONS.folder;
                } else {
                    const iconClass = getIconForFile(node.name);
                    if (iconClass) {
                        const i = document.createElement('i');
                        i.className = `${iconClass} text-xl`;
                        i.style.color = 'var(--icon-color)';
                        iconContainer.appendChild(i);
                    } else {
                        iconContainer.innerHTML = ICONS.file;
                    }
                }
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = node.name;
                nameSpan.className = 'text-sm';

                itemDiv.appendChild(iconContainer);
                itemDiv.appendChild(nameSpan);
                li.appendChild(itemDiv);

                if (node.type === 'tree') {
                    const childrenUl = document.createElement('ul');
                    childrenUl.className = 'pl-6 space-y-1';
                    if (!expandFolders) {
                        childrenUl.classList.add('hidden');
                    }
                    renderTree(node.children, childrenUl, expandFolders);
                    li.appendChild(childrenUl);

                    itemDiv.onclick = (e) => {
                        e.stopPropagation();
                        const isHidden = childrenUl.classList.toggle('hidden');
                        iconContainer.innerHTML = isHidden ? ICONS.folder : ICONS.folderOpen;
                    };
                } else {
                    itemDiv.style.cursor = 'default';
                }

                ul.appendChild(li);
            }
            container.appendChild(ul);
        }

        /**
         * Main function to initialize the application.
         */
        async function main() {
            const params = new URLSearchParams(window.location.search);
            const repoUrl = params.get('repo');
            const theme = params.get('theme');
            const isTransparent = params.get('transparent') === 'true';

            // --- Theme & Style Setup ---
            if ((isTransparent && theme !== 'dark') || theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }

            if (isTransparent) {
                const rootStyle = document.documentElement.style;
                rootStyle.setProperty('--bg-color', 'transparent');
                rootStyle.setProperty('--card-bg', 'transparent');
                appContainer.classList.remove('p-4', 'md:p-6');
                views.tree.style.border = 'none';
            }
            
            if (!repoUrl) {
                showView('welcome');
                return;
            }

            fetchAndRenderRepo();
        }
        
        async function fetchAndRenderRepo() {
            const params = new URLSearchParams(window.location.search);
            const repoUrl = params.get('repo');
            const expandFolders = params.get('expand') === 'true';
            const repoInfo = parseGitHubUrl(repoUrl);

            if (!repoInfo) {
                errorMessageEl.textContent = 'Invalid GitHub repository URL provided.';
                showView('error');
                return;
            }
            
            showView('loading');
            
            const headers = {};
            const storedToken = localStorage.getItem(GITHUB_TOKEN_KEY);
            if (storedToken) {
                headers['Authorization'] = `Bearer ${storedToken}`;
            }

            try {
                const repoDetailsRes = await fetch(`https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}`, { headers });
                
                if (repoDetailsRes.status === 403 && repoDetailsRes.headers.get('X-RateLimit-Remaining') === '0') {
                    showView('rateLimit');
                    return;
                }
                
                if (!repoDetailsRes.ok) {
                    const errorData = await repoDetailsRes.json();
                    throw new Error(errorData.message || `Could not fetch repository details. Status: ${repoDetailsRes.status}.`);
                }
                const repoDetails = await repoDetailsRes.json();
                
                const treeRes = await fetch(`https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/git/trees/${repoDetails.default_branch}?recursive=1`, { headers });
                if (!treeRes.ok) {
                    const errorData = await treeRes.json();
                    throw new Error(errorData.message || `Could not fetch repository file tree. Status: ${treeRes.status}.`);
                }
                const treeData = await treeRes.json();
                
                if (treeData.truncated) console.warn("Repository is too large; the file tree has been truncated.");

                repoTitleEl.textContent = repoDetails.full_name;
                repoLinkEl.href = repoDetails.html_url;

                const fileTree = buildFileTree(treeData.tree);
                treeContainer.innerHTML = '';
                renderTree(fileTree, treeContainer, expandFolders);
                
                showView('tree');

            } catch (error) {
                console.error('Error fetching repository:', error);
                errorMessageEl.textContent = error.message;
                showView('error');
            }
        }

        saveTokenBtn.addEventListener('click', () => {
            const token = patInput.value;
            if (token) {
                localStorage.setItem(GITHUB_TOKEN_KEY, token);
                patInput.value = ''; // Clear the input
                fetchAndRenderRepo(); // Retry fetching
            }
        });

        clearTokenBtn.addEventListener('click', () => {
            localStorage.removeItem(GITHUB_TOKEN_KEY);
            patInput.value = '';
            // You might want to show a confirmation message here
        });

        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>

